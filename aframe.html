<html>
	<head>
		<title>POC on WebVR using AFrame</title>				
		<link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-icons.css" />		
		<link rel="stylesheet" type="text/css" href="css/fontawesome-free/css/all.min.css" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<script src="scripts/jquery/jquery-3.6.0.min.js"></script>
		<script src="scripts/bootstrap/bootstrap.min.js"></script>
		<script src="scripts/popper.min.js"></script>		
		<script src="scripts/adapter-latest.js"></script>
		<script src="scripts/aframe.min.js"></script>		
		<script src="scripts/networked-aframe.min.js"></script>  
		<script src="scripts/aframe-environment-component.min.js"></script>		
		<script src="scripts/dynamic-room-component.js"></script>
		<script src="scripts/aframe-extras.min.js"></script>
		<script src="scripts/naf-janus-adapter.js"></script>
		<script>
			AFRAME.components["networked-scene"].schema.connectOnLoad.default = false;
				
			AFRAME.registerComponent('spectator',{
				'schema': {
					canvas: {
						type: 'string',
						default: ''
					},
					// desired FPS of spectator dislay
					fps: {
						type: 'number',
						default: '30.0'
					}
				},
				'init': function() {
					var targetEl = document.querySelector(this.data.canvas)

					this.counter = 0;
					this.renderer = new THREE.WebGLRenderer( { antialias: true } );

					this.renderer.setPixelRatio( window.devicePixelRatio );
					this.renderer.setSize( targetEl.offsetWidth, targetEl.offsetHeight );

					// creates spectator canvas
					targetEl.appendChild(this.renderer.domElement);
				},
				'tick': function(time, timeDelta) {
					var loopFPS = 1000.0 / timeDelta;
					var hmdIsXFasterThanDesiredFPS = loopFPS / this.data.fps;
					var renderEveryNthFrame = Math.round(hmdIsXFasterThanDesiredFPS);

					if(this.counter % renderEveryNthFrame === 0){
						this.render(timeDelta);
					}
					this.counter += 1;  
				},
				'render': function(){
					this.renderer.render( this.el.sceneEl.object3D , this.el.object3DMap.camera );
				}
			});
	  
			AFRAME.registerComponent('video-functions', {
				init: function() {
					let self = this;
					this.el.addEventListener('click', function(event) {
						var v = document.getElementById('demo');						
						if (!v.paused) {
							v.pause();
						} else {
							v.play();
						}
					})
				}
			});			
			
			NAF.schemas.getComponentsOriginal = NAF.schemas.getComponents;
			NAF.schemas.getComponents = (template) => {
				if (!NAF.schemas.hasTemplate("#avatar-template")) {
					NAF.schemas.add({
						template: '#avatar-template',
						components: [
							'position',
							'rotation',
							'animation-mixer',
							{
								selector: '.head',
								component: 'material',
								property: 'color'
							},
							{
								selector: '.nametag',
								component: 'text',
								property: 'value'
							},
							{
								selector: '.nametagBack',
								component: 'text',
								property: 'value'
							}
						]
					});
				}
				
				if (!NAF.schemas.hasTemplate("#share-screen-template")) {
					NAF.schemas.add({
						template: '#share-screen-template',
						components: [
							'position',
							'rotation'
						]
					});
				}
				
				const components = NAF.schemas.getComponentsOriginal(template);
				return components;
			}
		</script>
		<script src="scripts/aframe-randomizer-components.min.js"></script>
		<script src="scripts/aframe-particle-system-component.min.js"></script>
		<script src="scripts/spawn-in-circle.component.js"></script>
		<script src="scripts/color-changer.js"></script>
		<script src="scripts/aframe-inspector-plugin-recast.js"></script>
		<script src="scripts/Geometry.js"></script>
		<script src="scripts/aframe-look-at-component.min.js"></script>
		<style>
			 .btn-circle.btn-sm {
            	width: 30px;
            	height: 30px;
            	padding: 6px 0px;
            	border-radius: 15px;
            	font-size: 8px;
            	text-align: center;
        	}
        	.btn-circle.btn-md {
	            width: 50px;
            	height: 50px;
            	padding: 7px 10px;
            	border-radius: 25px;
            	font-size: 10px;
            	text-align: center;
        	}
        	.btn-circle.btn-xl {
	            width: 70px;
            	height: 70px;
            	padding: 10px 16px;
            	border-radius: 35px;
            	font-size: 12px;
            	text-align: center;
        	}
		</style>
  </head>
  <body>
	<div id="meetingroom_div"></div>  		
	
	<div id="participantUI"></div>
	
	<a-scene id="scene" dynamic-room networked-scene
		cursor="rayOrigin: mouse"
		raycaster="objects:.raycastable"
		inspector-plugin-recast
		light="defaultLightsEnabled: false"
		vr-mode-ui="enabled: false"
		>
		<a-assets>
			<video id="demo" src="video/MS_vs_Meta.mp4"></video>
			<!--<video id="viutv" src="https://viu.tv/" crossorigin></video>-->
			<img id="pink" src="images/1hyyIUi.jpg" crossorigin="anonymous" />
			<img src="images/floor.png" id="grid" crossorigin="anonymous" />
			<img src="images/WMNH2OF.jpg" id="chrome" crossorigin="anonymous" />
			<!--<img id="sky" src="images/WqlqEkq.jpg" crossorigin="anonymous" />-->
			<img id="sky" src="images/HdrOutdoorCityPathDayClear001_JPG_4K.jpg" crossorigin="anonymous" />
			<img id="ha" src="images/ha_logo.png" crossorigin="anonymous" />
			<!--<img id="floor" src="images/FabricDenim_3K.jpg" crossorigin="anonymous" />-->
			<img id="floor" src="images/CarpetTwistNatural001_COL_4K.jpg" crossorigin="anonymous" />

			<a-asset-item id="dawningFont" src="fonts/dawningOfANewDayRegular.typeface.json?1490305922844"></a-asset-item>
			<a-asset-item id="exoFont" src="fonts/exo2Black.typeface.json?1490305922150"></a-asset-item>
			<a-asset-item id="exoItalicFont" src="fonts/exo2BlackItalic.typeface.json?1490305922725"></a-asset-item>
			
			<a-asset-item id="avatarModel1" src="glb/avatar_v4.gltf"></a-asset-item>
			
			<a-asset-item id="tableCross" src="glb/tableCross.glb"></a-asset-item>
			<a-asset-item id="chairDesk" src="glb/chairDesk.glb"></a-asset-item>
			<a-asset-item id="wall" src="glb/wall2.glb"></a-asset-item>
			<a-asset-item id="wallCorner" src="glb/wallCorner.glb"></a-asset-item>
			<a-asset-item id="wallDoorway" src="glb/wallDoorway2.glb"></a-asset-item>
			<a-asset-item id="pottedPlant" src="glb/pottedPlant.glb"></a-asset-item>
			<a-asset-item id="trashcan" src="glb/trashcan.glb"></a-asset-item>
			<a-asset-item id="floor" src="glb/floorFull.glb"></a-asset-item>
			<a-asset-item id="trashcan2" src="glb/trash_can.glb"></a-asset-item>
			<a-asset-item id="table" src="glb/table_2.gltf"></a-asset-item>
			<a-asset-item id="plant" src="glb/plant.glb"></a-asset-item>
			<a-asset-item id="flower" src="glb/flower.glb"></a-asset-item>
			<a-asset-item id="computerchair" src="glb/computerchair.glb"></a-asset-item>
			<a-asset-item id="navmesh" src="glb/navmesh_5.gltf"></a-asset-item>
			<a-asset-item id="conferenceTable" src="glb/conferenceTable.gltf"></a-asset-item>
			
			<!-- Network asset -->						
			<template id="share-screen-template">
				<a-entity class="share_screen">
					<!--<a-entity look-at="#player" class="scr" geometry="primitive: plane; width: 8; height: 4.5;" position = "0 3.5 2" rotation="0 180 0" material="side:front;" networked-video-source="streamName: screen"></a-entity>-->
					<!--<a-entity class="scr_user" id="scr_user"  scale="6 6 6" position="2.8 8.8 -3" material="color:#000000" rotation="0 -90 0" text="value: Someone will share screen" ></a-entity>-->
					<!--<a-entity class="scr" geometry="primitive: plane; width: 12; height: 6.75;" position = "2.8 5 -3.5" rotation="0 -90 0" material="side:front;" networked-video-source="streamName: screen"></a-entity>-->
					<a-entity class="scr" geometry="primitive: plane; width: 24; height: 13.5;" position = "5.8 7.3 -9.5" rotation="0 -90 0" material="side:front;" networked-video-source></a-entity>					
				</a-entity>
			</template>
									
			<template id="avatar-template">				
				<a-entity class="avatar">	
					<a-entity id="voice" class="voice" networked-audio-source></a-entity>
					<a-entity id="nametag" class="nametag" text="value: ??; align:center;" position="0 3.5 0" rotation="0 180 0" scale="3 3 3"></a-entity>
					<a-entity id="nametagBack" class="nametagBack" text="value: ??; align:center;" position="0 3.5 0" rotation="0 0 0" scale="3 3 3"></a-entity>
					<a-entity id="head" class="head" gltf-model="#avatarModel1" rotation="0 180 0" scale="1.6 1.6 1.6" position="0 -2 0"></a-entity>
				</a-entity>
			</template>
			<div id="template_div"></div>			
		</a-assets>
		<!--<div id="player_div"></div>	-->
		
		<a-entity id="player" movement-controls="constrainToNavMesh:true;" position="-14 0 3" animation-mixer="clip:idle;" look-controls>
			<a-entity id="cam" class="cam" camera position="0 2.6 0"></a-entity>
			<a-entity id="nametag" class="nametag" text="value: ??; align:center;" position="0 3.1 0.6" rotation="0 180 0" scale="3 3 3">
			</a-entity>
			<a-entity id="nametagBack" class="nametagBack" text="value: ??; align:center;" position="0 3.1 0.6" rotation="0 0 0" scale="3 3 3"> 
			</a-entity>
			<a-entity id="corp" class="corp">
			</a-entity>
			<a-entity id="localAvatar" class="localAvatar" rotation="0 180 0" scale="1.6 1.6 1.6" position="0 0 0.6">
			</a-entity>			
			<a-sphere color="red" radius="1.2" position="0 2 0.6"></a-sphere>
		</a-entity>		
		<!--adds the text with custom font-->
		<a-entity position="-3 1 -6" rotation="5 0 0">		
			<a-entity
				rotation="0 0 0"
				position="-8 4 -16.5">
				<a-image src="#ha"></a-image>
			</a-entity>
			<a-entity
				rotation="0 0 0"
				position="2 4 -16.5"
				text="font: aileronsemibold; value: Hospital Authority; width: 18; color:black;"
				material="color:lavenderblush; metalness:1; roughness: 0; sphericalEnvMap: #pink;">
			</a-entity>
			<!--adds the text with custom font-->
			<a-entity position="-1 3 -16.5" scale="0.6 1.2 1" text="font: aileronsemibold; value: POC on WebVR; width: 16; color:black;" material="color:pink; metalness:0.9; roughness: 0.05; sphericalEnvMap: #chrome;"></a-entity>
		</a-entity>
		
		<a-entity class="scr_background" geometry="primitive: plane; width: 24; height: 13.5;" position = "6 7.3 -9.5" rotation="0 -90 0" material="color:#000000"></a-entity>
			
		<a-entity 
			  geometry="primitive: plane; width: 50; height: 50;" rotation="-90 0 0"
			  material="src: #floor; repeat: 30 30; transparent: true;"
			  <!--material="src: #grid; repeat: 50 50; transparent: true;metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"-->			  
			  >
		</a-entity>

		<!--adds the lighting to make the scene more realistic-->
		<!--
		<a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
		<a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>
		-->
		<!--adds the sky-->
		<!--<a-sky src="#sky" rotation="0 -90 0"></a-sky>-->
<!--		<a-sky src="#sky" radius="50" ></a-sky> -->
		<a-sky  color="#E5F7FB" radius="100" ></a-sky>
		<a-entity id="room" position="0 0 0">
			<a-entity id="wall1" gltf-model="#wall" scale="15 11.5 2" position="-8 0.2 4"></a-entity>
			<a-entity id="door" gltf-model="#wallDoorway" scale="12 11.5 2" position="-20 0.2 4"></a-entity>
			<a-entity id="wall3" gltf-model="#wall" scale="27 11.5 2" position="-20 0.2 -23" rotation="0 -90 0"></a-entity>			
			<a-entity id="wall4" gltf-model="#wall" scale="27 11.5 2" position="7 0.2 4" rotation="0 90 0"></a-entity>
			<a-entity id="wall2" gltf-model="#wall" scale="27 11.5 2" position="7 0.2 -23" rotation="0 180 0"></a-entity>		
			<a-entity id="plant1" gltf-model="#plant" scale="0.02 0.02 0.02" position="-18.3 0.2 2.275" rotation="270 0 0"></a-entity>
			<!--<a-entity id="flower1" gltf-model="#flower" scale="0.025 0.025 0.025" position="-4.5 1.54 -1.683" rotation="270 0 0"></a-entity>
			<a-entity id="flower2" gltf-model="#flower" scale="0.025 0.025 0.025" position="-8 1.54 -1.683" rotation="270 90 0"></a-entity>
			<a-entity id="table" gltf-model="#table" scale="0.9 0.65 0.9" position="-5.68 0.2 -3" rotation="0 90 0"></a-entity>-->
			<a-entity id="conferenceTable" gltf-model="#conferenceTable" scale="4 2 1.5" position="-2.2 -1.66 -8.8" rotation="0 90 0"></a-entity>
			<a-entity id="computerchair1" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 115 0" position="-2.6 0.2 -1.7"></a-entity>
			<a-entity id="computerchair2" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 110 0" position="-3.25 0.2 -3.7"></a-entity>
			<a-entity id="computerchair3" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 105 0" position="-3.6 0.2 -5.7"></a-entity>
			<a-entity id="computerchair4" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 100 0" position="-3.8 0.2 -7.7"></a-entity>
			<a-entity id="computerchair5" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 90 0" position="-3.8 0.2 -9.7"></a-entity>
			<a-entity id="computerchair6" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 80 0" position="-3.8 0.2 -11.7"></a-entity>
			<a-entity id="computerchair7" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 75 0" position="-3.6 0.2 -13.7"></a-entity>
			<a-entity id="computerchair8" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 70 0" position="-3.25 0.2 -15.7"></a-entity>
			<a-entity id="computerchair9" class="chair raycastable" gltf-model="#computerchair" scale="0.23 0.23 0.23" rotation="0 65 0" position="-2.6 0.2 -17.7"></a-entity>
			<a-entity id="trashcan" gltf-model="#trashcan2" scale="2.3 1.5 1.5" position="-18.7 0.2 -22.16" rotation="0 0 0"></a-entity>			
			
			<a-entity id="navmesh" gltf-model="#navmesh" nav-mesh position="0 0.1 0" visible="false"></a-entity>
		</a-entity>
		
		<!--<a-video class="raycastable" id="demoVideo" src="#demo" width="8" height="4.5" position="-6.5 5 3.5" rotation="0 180 0" video-functions></a-video>-->
		<!--<a-video class="raycastable" id="viu" src="#viutv" width="8" height="4.5" position="-6.5 5 3.5" rotation="0 180 0"></a-video>-->

		<a-entity id="secondaryCamera" position="0 15 0" rotation="-90 0 0">
			<a-camera spectator="canvas:#spectatorDiv;" active="false" wasd-controls-enabled="false" look-controls-enabled="false">
			</a-camera>
		</a-entity>
		<a-entity id="screenCamera" position="-2.3 5.7 -9.5" rotation="0 270 0">
			<a-camera id="screenCam" spectator="canvas:#spectatorScreenDiv;" active="false" wasd-controls-enabled="false" look-controls-enabled="false">
			</a-camera>
		</a-entity>
		<a-entity light="type: ambient; color: #FEFEFE; intensity: 0.8;"></a-entity>
		<a-light type="directional" intensity="0.8" position="0 0 0" rotation="-90 0 0" target="#directionaltarget">
    		<a-entity id="directionaltarget" position="0 0 -1"></a-entity>
		</a-light>
		<a-light type="directional" intensity="0.2" position="0 0 0" rotation="0 270 0" target="#directionaltargetb">
    		<a-entity id="directionaltargetb" position="0 0 -1"></a-entity>
		</a-light>
	</a-scene>

	<div id="chatUI" class="chatUI">
		<div id="chatTab">
			<button id="chatTabChat" class="chatTabLinks btn btn-primary" onclick="switchChat('chat-div');"><i id="chat-icon" class="bi bi-chat-fill"></i>&nbsp;Chat</button>
			<button id="chatTabPM" class="chatTabLinks btn btn-primary" onclick="switchChat('pm-div');"><i id="pm-icon" class="bi bi-file-lock"></i>&nbsp;Private Message</button>
		</div>
		<div id="chat-div" class="chatTabContent show">			
			<p>Send message to all users:</p>
			<p><input id="message-input" type="text" class="form-control"><button id="send-text-btn" class="btn btn-secondary"><i class="bi bi-send"></i>&nbsp;Send</button></p>
			<div id="chat-messages" class="chatMessage"></div>
		</div>
		<div id="pm-div" class="chatTabContent">
			<p>Please select user to PM: <select name="select-pm-target" id="select-pm-target">
				<option value="0">--Please Select--</option>
			</select></p>
			<p><input id="pm-message-input" type="text" class="form-control"><button id="send-pm-text-btn" class="btn btn-secondary"><i class="bi bi-send"></i>&nbsp;Send PM</button></p>
			<div id="pm-messages" class="pm-messages"></div>
		</div>
	</div>

	<div id="spectatorDiv" style="opacity: 0;text-align: right; background-color: transparent;">		
		<button id="mapMode-btn" onclick="this.blur();">Switch to Player Centric Mode</button>
		<button id="zoomIn-btn" onclick="this.blur();"><i class="bi bi-zoom-in"></i></button>
		<button id="zoomOut-btn" onclick="this.blur();"><i class="bi bi-zoom-out"></i></button>	
	</div>
	
	<div id="spectatorScreenDiv" style="opacity: 0;text-align: right;background-color: transparent;">
	</div>

	<div id="helpDiv" class="helpDiv">
		<table align="center">
			<tr height="100%">
				<td colspan="2" height="100%" width="100%" valign="middle" align="center">
					<i class="bi bi-question" style="font-size:2rem;"></i>&nbsp;How to Use
				</td>
			</tr>			
		</table>
		<table align="center" border="1" cellpadding="1" cellspacing="1">
			<tr>
				<td>Controls: </td>
				<td>Use "W", "S", "A", "D" key to move forward, backward, left and right</td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td>Mouse drag to face left/ right and up/down</td>
			</tr>
			<tr>
				<td colspan="2">&nbsp;</td>
			</tr>
			<tr>
				<td><i class="bi bi-mic"></i></td>
				<td>Mute or un-mute the microphone</td>
			</tr>
			<tr>
				<td><i class="bi bi-camera"></i></td>
				<td>Share the camera</td>
			</tr>
		</table>
	</div>

	<div class="actions">		
		<button id="audio-btn" type="button" title="Mute/Un-Mute" class="btn btn-primary btn-circle btn-md"><i id="mic-icon" class="bi bi-mic" style="font-size:2rem;"></i></button>&nbsp;&nbsp;
		
		<button id="camera-btn" type="button" title="Share Camera" class="btn btn-primary btn-circle btn-md"><i id="cam-icon" class="bi bi-camera" style="font-size:2rem;"></i></button>&nbsp;&nbsp;		
		<button id="screen-btn" type="button" title="Share Screen" class="btn btn-primary btn-circle btn-md"><i id="screen-icon" class="bi bi-tv" style="font-size:2rem;"></i></button>&nbsp;&nbsp;				
		
		<button id="chat-text-btn" type="button" title="Chat" class="btn btn-primary btn-circle btn-md"><i id="chat-text-icon" class="bi bi-chat-text" style="font-size:2rem;"></i></button>&nbsp;&nbsp;

		<button id="map-btn" type="button" title="Show Map" class="btn btn-primary btn-circle btn-md" onclick="this.blur();"><i id="map-icon" class="bi bi-map" style="font-size:2rem;"></i></button>&nbsp;&nbsp;
		<button id="present-btn" type="button" title="Present Mode" class="btn btn-primary btn-circle btn-md" onclick="this.blur();"><i id="present-icon" class="bi bi-file-easel" style="font-size:2rem;"></i></button>&nbsp;&nbsp;
		<button id="viewscreen-btn" type="button" title="View Screen" class="btn btn-primary btn-circle btn-md" onclick="this.blur();"><i id="viewscreen-icon" class="bi bi-aspect-ratio" style="font-size:2rem;"></i></button>&nbsp;&nbsp;	
		
		<button id="help-btn" type="button" title="Help" class="btn btn-primary btn-circle btn-md"><i id="help-icon" class="bi bi-question-circle" style="font-size:2rem;"></i></button>&nbsp;&nbsp;
		<!--
		<button id="greetings-btn" type="button" title="Greeting" class="btn btn-primary greetings-btn btn-circle btn-md"><i class="fas fa-glass-cheers" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;		
		<button id="waving-btn" type="button" title="Wave Hand" class="g-btn btn btn-primary btn-circle btn-md"><i class="fas fa-hands-wash" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;
		<button id="shake-hand-btn" type="button" title="Hand Shake" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-handshake" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;
		<button id="raise-hand-btn" type="button" title="Raise Hand" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-hand-paper" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="clap-hand-btn" type="button" title="Hand Clap" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-thumbs-up" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="yes-btn" type="button" title="Yes" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-thumbs-up" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="no-btn" type="button" title="No" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-thumbs-down" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="gangnam-btn" type="button" title="Gangnam Style" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-thumbs-up" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="hiphop-btn" type="button" title="Hip Hop" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-thumbs-up" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		-->
	</div>	

	<div class="greetings">
		<button id="waving-btn" type="button" title="Wave Hand" class="g-btn btn btn-primary btn-circle btn-md"><i class="fas fa-hand-sparkles" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;
		<button id="raise-hand-btn" type="button" title="Raise Hand" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-hand-paper" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="clap-hand-btn" type="button" title="Hand Clap" class="g-btn btn btn-primary btn-circle btn-md"><i class="fas fa-praying-hands" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="yes-btn" type="button" title="Yes" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-thumbs-up" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="no-btn" type="button" title="No" class="g-btn btn btn-primary btn-circle btn-md"><i class="far fa-thumbs-down" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="gangnam-btn" type="button" title="Gangnam Style" class="g-btn btn btn-primary btn-circle btn-md"><i class="fas fa-horse" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
		<button id="hiphop-btn" type="button" title="Hip Hop" class="g-btn btn btn-primary btn-circle btn-md"><i class="fas fa-running" style="font-size:1.5rem;"></i></button>&nbsp;&nbsp;	
	</div>
	
	<div class="ava-actions">
		<!--
		<img id="pm-btn" src="images/private_message.png" alt="Private Message" title="Private Message" width="32" height="32" />
		<img id="teleport-btn" src="images/teleport.png" alt="Teleport To" title="Teleport To" width="32" height="32" />
		-->
		<button id="pm-btn" title="PM" class="btn btn-primary"><i class="bi bi-file-lock"></i></button>
		<button id="teleport-btn" title="Teleport To" class="btn btn-primary"><i class="bi bi-box-arrow-right"></i></button>
	</div>
	
	<div class="chair-actions">
		<!--<img id="sitdown-btn" src="images/sit.png" alt="Sit Down" title="Sit Down" width="32" height="32" />-->
		<button id="sitdown-btn" title="Sit" class="btn btn-primary"><i class="fas fa-chair"></i></button>
	</div>

	
	
	<!--
	<div id="vittv" class="viutv">
		<iframe id="viu-frame" class="viu-frame" src="https://viu.tv/ch/99" frameborder="0"></iframe>
	</div>
	-->
	<script>
		const params = getUrlParams();				
		const usersMap = {};
		const pmMap = {};
		const state = {};
		const playerInfo = {};
		const chairs = {};
		const sitdownEyeLevel = 2.1;
				
		var chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.9;
		chairArrayRow["user"] = "";
		chairs["computerchair1"] = chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.85;
		chairArrayRow["user"] = "";
		chairs["computerchair2"] = chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.8;
		chairArrayRow["user"] = "";
		chairs["computerchair3"] = chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.75;
		chairArrayRow["user"] = "";
		chairs["computerchair4"] = chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.715;
		chairArrayRow["user"] = "";
		chairs["computerchair5"] = chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.66;
		chairArrayRow["user"] = "";
		chairs["computerchair6"] = chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.61;
		chairArrayRow["user"] = "";
		chairs["computerchair7"] = chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.56;
		chairArrayRow["user"] = "";
		chairs["computerchair8"] = chairArrayRow;
		chairArrayRow = {};		
		chairArrayRow["yaxis"] = 4.51;
		chairArrayRow["user"] = "";
		chairs["computerchair9"] = chairArrayRow;
		
		state.currentStream = null;
		state.cameraEnabled = false;		
		state.screenEnabled = false;
		state.audioEnabled = true;
		state.stand = true;
		state.sit = false;
		state.presentEnabled = false;
		
		const ledColor = ["#64ff00", "#64ff00", "#9bff00", "#d4ff00", "#fbff00", "#ffd500", "#ffa600", "#ff5d00", "#ff0800", "#ff0800"];
		
		const scene = document.querySelector('a-scene');		
		const sendTextBtnEl = document.getElementById('send-text-btn');				
		const audioBtnEl = document.getElementById('audio-btn');
		const chatTextBtnEl = document.getElementById('chat-text-btn');
		const cameraBtnEl = document.getElementById('camera-btn');	
		const screenBtnEl = document.getElementById('screen-btn');
		const wavingBtnEl = document.getElementById('waving-btn');	
		const shakeHandBtnEl = document.getElementById('shake-hand-btn');	
		const raiseHandBtnEl = document.getElementById('raise-hand-btn');	
		const clapHandBtnEl = document.getElementById('clap-hand-btn');
		const yesBtnEl = document.getElementById('yes-btn');
		const noBtnEl = document.getElementById('no-btn');
		const gangnamBtnEl = document.getElementById('gangnam-btn');
		const hiphopBtnEl = document.getElementById('hiphop-btn');
				
		const selectPmTargetEl = document.getElementById('select-pm-target');
		const pmBtnEl = document.getElementById('pm-btn');		
		const sendPmTextBtnEl = document.getElementById('send-pm-text-btn');
		
		const teleportBtnEl = document.getElementById('teleport-btn');
		
		const sitdownBtnEl = document.getElementById('sitdown-btn');
		const presentBtnEl = document.getElementById('present-btn');
		const mapBtnEl = document.getElementById('map-btn');
		const viewScreenBtnEl = document.getElementById('viewscreen-btn');
		const helpBtnEl = document.getElementById('help-btn');
		
		var viewScreenOpenedFlag = 'N';
		
		var mapOpenedFlag = 'N';
		var refreshIntervalId;	
		var secondaryCameraX = -8;
		var secondaryCameraY = 16;
		var secondaryCameraZ = -8;
		const zoomInBtnEl = document.getElementById('zoomIn-btn');
		const zoomOutBtnEl = document.getElementById('zoomOut-btn');
		const mapModeBtnEl = document.getElementById('mapMode-btn');
		var mapFixedModeFlag = 'Y';

		var cursorX = -1;
		var cursorY = -1;
		var avatarClicked = -1;
		var pmTarget = '';
		var rcvPmFrom = '';
		var countPmContent = 0;
		var currentPmTarget = '';
		var currentPmClientId = -1;

		var currentChair = '';
		var sitRefreshIntervalId;
		var chairYAxis = -999999;
		//var sitFlag = "N";

		var defaultPosX = -14;
		var defaultPosY = 0;
		var defaultPosZ = 3;
		
		zoomInBtnEl.addEventListener('click', function() {
			secondaryCameraY = secondaryCameraY - 1;
			
			if (secondaryCameraY < 8) {
				secondaryCameraY = 8;
			}
			
			if (mapFixedModeFlag == 'Y') {
				mapFixedMode();
			}
			//console.log("secondaryCameraY 1: " + secondaryCameraY);
		});	

		zoomOutBtnEl.addEventListener('click', function() {
			secondaryCameraY = secondaryCameraY + 1;
			
			if (secondaryCameraY > 50) {
				secondaryCameraY = 50;
			}

			if (mapFixedModeFlag == 'Y') {
				mapFixedMode();
			}
			//console.log("secondaryCameraY 2: " + secondaryCameraY);
		});	

		function mapFixedMode() {
			var secondaryCamera = document.getElementById('secondaryCamera');
			secondaryCamera.setAttribute('position', secondaryCameraX + ' ' + secondaryCameraY + ' ' + secondaryCameraZ);
		}
		
		function mapNonFixedMode() {
			var playerAvatar = document.getElementById('player');
			var secondaryCamera = document.getElementById('secondaryCamera');
			refreshIntervalId = setInterval(function () { 
									var playerAvatarPosition = playerAvatar.getAttribute('position');
									//console.log("playerAvatarPosition: ", playerAvatarPosition);
									secondaryCamera.setAttribute('position', playerAvatarPosition.x + ' ' + secondaryCameraY + ' ' + playerAvatarPosition.z);
									//console.log("secondaryCamera: ", secondaryCamera.getAttribute('position'));
								}, 10);
		}
		
		function leaveChair() {
			clearInterval(sitRefreshIntervalId);
			//sitFlag = "N";
			state.sit = false;
			
			var p = document.getElementById('player');
			p.setAttribute('animation-mixer', 'clip', 'idle');
			var c = document.getElementById('cam');
			c.setAttribute('position', '0 2.6 0');
			
			$.each( chairs, function( key, value ) {
				if (key != "") {
					if (chairs[key]["user"] == NAF.clientId) {
						chairs[key]["user"] = "";
						NAF.connection.adapter.broadcastData("chairStatus", {usedFlag: "N", currentChairId: key, sender: getUserCorpId(), senderId: NAF.clientId});
						//console.log('chairs leave broadcast ');
					}
				}
			});			
			//console.log('chairs leave: ' + JSON.stringify(chairs));
		}
		
		function releaseChair(clientId) {
			$.each( chairs, function( key, value ) {
				if (key != "") {
					if (chairs[key]["user"] == clientId) {
						chairs[key]["user"] = "";
					}
				}
			});			
			//console.log('chairs release: ' + JSON.stringify(chairs));
		}

		function setAvatar(params) {							
			var corpid = params.corpid;
			var randomX = defaultPosX + (Math.random() + 1) / 2;
			var randomZ = defaultPosZ + (Math.floor(Math.random() * 10) + 1) / 2;
			$.ajax({
				url: "https://160.1.42.191:9876/users/corp/" + corpid,
				type: "GET",
				success: function(d) {
					playerInfo.corpid = d.corpid;
					playerInfo.nickname = d.nickname;
					playerInfo.photo = d.photo;
					playerInfo.avatar = d.avatar;

					var p = document.getElementById('player');
					p.setAttribute('position', randomX + ' ' + defaultPosY + ' ' + randomZ);
					p.setAttribute('networked', 'template:#'+playerInfo.corpid+'-avatar-template;attachTemplateToLocal:false;');
					
					var c = document.getElementById('corp');
					c.setAttribute('text', 'value', playerInfo.corpid);

					var n = document.getElementById('nametag');
					n.setAttribute('text', 'value', playerInfo.nickname);	
					
					var nb = document.getElementById('nametagBack');
					nb.setAttribute('text', 'value', playerInfo.nickname);	
					
					var l = document.getElementById('localAvatar');
					l.setAttribute('gltf-model', 'glb/' + playerInfo.avatar);	
					
					p.setAttribute('corpid', playerInfo.corpid);
					p.setAttribute('display_name', playerInfo.nickname);
				}
			});							
		}

		function switchChat(chatType) {
			var i, tabcontent, tablinks;

			tabcontent = document.getElementsByClassName("chatTabContent");
			for (i = 0; i < tabcontent.length; i++) {
				tabcontent[i].style.display = "none";				
			}

			tablinks = document.getElementsByClassName("chatTabLinks");
			for (i = 0; i < tablinks.length; i++) {
				tablinks[i].className = tablinks[i].className.replace(" active", "");					
			}

			document.getElementById(chatType).style.display = "block";
			if (chatType === "chat-div") {
				$('#chat-icon').removeClass('bi-chat');
				$('#chat-icon').addClass('bi-chat-fill');
				$('#pm-icon').removeClass('bi-file-lock-fill');
				$('#pm-icon').addClass('bi-file-lock');
			} else if (chatType === "pm-div") {
				$('#chat-icon').removeClass('bi-chat-fill');
				$('#chat-icon').addClass('bi-chat');
				$('#pm-icon').removeClass('bi-file-lock');
				$('#pm-icon').addClass('bi-file-lock-fill');
			}
			
		}

		function genClientId() {
			let num = '';
			for (let i = 0; i < 16; i++) {
				num += Math.floor(Math.random() * 10).toString();
			}
			return num;
		}

		function getUserCorpId() {
			var p = document.getElementById('player');
			return p.getAttribute('corpid');
		}

		function getUserDisplayName() {
			var p = document.getElementById('player');
			return p.getAttribute('display_name');
		}
		
		function getMeetingRoom() {
			var r = document.getElementById('meetingroom_div');
			return r.getAttribute('room_id');
		}

		function setVolLED(vol, senderId) {
			let user_div = document.getElementById(senderId + "_vol");
			let user_leds = Array.from(user_div.children);			
			let range = user_leds.slice(0, Math.round(vol/10));

			for (var i = 0; i < user_leds.length; i++) {
				user_leds[i].style.boxShadow = "-2px -2px 4px 0px #a7a7a73d inset, 2px 2px 4px 0px #0a0a0e5e inset";
			}
			for (var i = 0; i < range.length; i++) {
				range[i].style.boxShadow = `5px 2px 5px 0px #0a0a0e5e inset, -2px -2px 1px 0px #a7a7a73d inset, -2px -2px 6px 0px ${ledColor[i]} inset`;			
			}
		}

		function getUrlParams() {
    		var match;
    		var pl = /\+/g;  // Regex for replacing addition symbol with a space
    		var search = /([^&=]+)=?([^&]*)/g;
    		var decode = function (s) { return decodeURIComponent(s.replace(pl, ' ')); };
    		var query = window.location.search.substring(1);
    		var urlParams = {};
						
    		match = search.exec(query);
    		while (match) {
	      		urlParams[decode(match[1])] = decode(match[2]);
      			match = search.exec(query);
			}
						
			return urlParams;
		}

		function setParticipant(clientId, name, photoName, addListener) {
			var participant_div = document.getElementById('participantUI');
			var me = document.createElement('div');
			me.setAttribute('id', clientId + "_user");
			participant_div.append(me);
			var myName = document.createElement('div');			
			myName.setAttribute('id', clientId + '_name');
			
			if(addListener) {
				myName.innerHTML = "<font color=white>" + name + "</font><br/><img id='" + clientId + "_photo' class='participant_photo' src='photo/" + photoName + "' />";
			} else {
				myName.innerHTML = "<font color=white>" + name + "</font><br/><img id='" + clientId + "_photo' class='my_photo' src='photo/" + photoName + "' />";
			}
			
			me.append(myName);
			
			var vol_wrapper = document.createElement('div');
			vol_wrapper.setAttribute('id', clientId + '_vol');
			vol_wrapper.setAttribute('class', 'volumen-wrapper');
			for (let i = 0; i < 10; i++) {
				var led = document.createElement('div');				
				led.setAttribute('class', 'led');
				vol_wrapper.append(led);
			}
			me.append(vol_wrapper);

			if(addListener) {
				myPhoto = document.getElementById(clientId + '_photo');
				var rect = myPhoto.getBoundingClientRect();				
				
				myPhoto.addEventListener('click', function(e) {						
					avatarClicked = clientId;						
					$('.ava-actions').addClass('show') 
					//$('.ava-actions').css({top: rect.top, left: 50});
					$('.ava-actions').css({top: cursorY, left: 50});
					networkedComponentChild = usersMap[clientId].el.children;
					for (let i = 0; i < networkedComponentChild.length; i++) {									
						if (networkedComponentChild[i].className === "nametag") {						
							pmTarget = networkedComponentChild[i].getAttribute('text').value;															
						}
					}						
				});
			}
		}
		
		function removeParticipant(clientId) {
			var participant_div = document.getElementById('participantUI');
			var c = document.getElementById(clientId + "_user");
			participant_div.removeChild(c);
		}

		function getAudioVol() {
			console.log("Start getting audio volume...");
			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
			
			if (navigator.getUserMedia) {
				navigator.getUserMedia({
					audio: true
				},
				function(stream) {
					audioContext = new AudioContext();
					analyser = audioContext.createAnalyser();
					mic = audioContext.createMediaStreamSource(stream);
					processor = audioContext.createScriptProcessor(2048, 1, 1);
					
					analyser.smoothingTimeConstant = 0.8;
					analyser.fftSize = 1024;
					
					mic.connect(analyser);
					analyser.connect(processor);
					processor.connect(audioContext.destination);
					
					processor.onaudioprocess = function() {
						var array = new Uint8Array(analyser.frequencyBinCount);
						analyser.getByteFrequencyData(array);
						var values = 0;

						var length = array.length;
						for (var i = 0; i < length; i++) {
							values += (array[i]);
						}

						var average = values / length;				
						if (state.audioEnabled) {
							setVolLED(average, NAF.clientId); //To update the volume leds
							if (average >= 30 || average < 10) { //If network traffic too much, can add the if block back so that broadcast at a certain level of volume								
								NAF.connection.adapter.broadcastData("talking", {muteStatus: false, vol: average, sender: getUserCorpId(), senderId: NAF.clientId});							
							} 
						}						
					}
				},
				function(err) {
					console.log("Got error:", err.name);
				});	
			} else {
				console.log("getUserMedia not supported");
			}
		}

		function setup(params) {
			var roomid = params.room.split('|')[0];
			var roomname = params.room.split('|')[1];	

			var m = document.getElementById('meetingroom_div');	
			m.setAttribute('room_id', roomid);
			m.setAttribute('room_name', roomname);
	
			//Get the meeting attendees and generate the template schema
			var assets = document.getElementById('a-assets');
			var temp_div = document.getElementById('template_div');
			$.ajax({
        		url: "https://160.1.42.191:9876/meetings/" + roomid,
        		type: "GET",
        		success: function(data) {		  					
					attend = data.attendees;
					//console.log(attend);
					attend.forEach(function(a) {	
						$.ajax({
							url: "https://160.1.42.191:9876/users/corp/" + a.corpid,
							type: "GET",
							success: function(d) {								
								//console.log(d);																
								var template_string = "";
								template_string += "<template id='" + d.corpid + "-avatar-template'>";
								template_string += "<a-entity class='avatar'>";		
								//template_string += "<a-entity id='cam' class='cam' camera position='0 2.6 0'></a-entity>";
								//CORP ID
								template_string += "<a-entity id='corp' class='corp' text='value:" + d.corpid + ";' visible='false'></a-entity>"
								//Voice
								template_string += "<a-entity id='voice' class='voice' networked-audio-source></a-entity>";
								//Name
								template_string += "<a-entity id='nametag' class='nametag' text='value:" + d.nickname + ";align:center;' position='0 3.1 0' rotation='0 180 0' scale='3 3 3'></a-entity>";
								template_string += "<a-entity id='nametagBack' class='nametagBack' text='value:" + d.nickname + ";align:center;' position='0 3.1 0' rotation='0 0 0' scale='3 3 3'></a-entity>";
								//Photo
								template_string += "<a-entity id='photo' class='photo' text='value:" + d.photo + "' visible='false'></a-entity>";
								//Head
								template_string += "<a-entity id='head' class='head raycastable' gltf-model='glb/" + d.avatar + "' position='0 0 0' rotation='0 180 0' scale='1.6 1.6 1.6'></a-entity>";
								template_string += "</a-entity>";
								template_string += "</template>";
								
								temp_div.innerHTML += template_string;

								NAF.schemas.add({
									template: '#' + d.corpid + '-avatar-template',
									components: [
										'position',
										'rotation',
										'animation-mixer',
										{
											selector: '.head',
											component: 'material',
											property: 'color'
										},
										{
											selector: '.nametag',
											component: 'text',
											property: 'value'
										},
										{
											selector: '.nametagBack',
											component: 'text',
											property: 'value'
										},
										{
											selector: '.photo',
											component: 'text',
											property: 'value'
										}
									]
								});
							}
						});									
					});					  
				}				    	
   			});	
		}

		function setPM(targetName, targetId) {
			switchChat('pm-div');
			document.getElementById('select-pm-target').value = targetId;
			currentPmTarget = targetName;
			currentPmClientId = targetId;
			
			if (!pmMap[avatarClicked]) {
				countPmContent++;
				pmMap[avatarClicked] = {
					name: pmTarget,
					msg: ''
				};					
			} else {
				var pmMessageInput = document.getElementById("pm-message-input");					
				var pmMessages = document.getElementById("pm-messages");
				if (avatarClicked === currentPmClientId) {
					pmMessageInput.focus;
					pmMessages.innerHTML = pmMap[currentPmClientId].msg
				}
			}			
		}

		function teleportTo(position) {
			var p = document.getElementById('player');
			//console.log(p.getAttribute('position'));
			//parameter position should be in the format '0 0 0'
			p.setAttribute('position', position);
			//console.log(p.getAttribute('position'));
		}

		document.addEventListener('DOMContentLoaded', () => {
			console.log('DOMContentLoaded');						
			//console.log(params);			
			setup(params);
			setAvatar(params);
			
			const stopAndRemoveVideoTrack = async () => {				
				const videoTracks = state.currentStream.getVideoTracks();
				if (videoTracks.length > 0) {
					videoTracks[0].stop();
					state.currentStream.removeTrack(videoTracks[0]);
					await NAF.connection.adapter.setLocalMediaStream(state.currentStream);
				}				
			};

			selectPmTargetEl.addEventListener('change', function() {
				//console.log(this.value);
				//console.log(this.options[this.selectedIndex].text);
				avatarClicked = this.value;
				setPM(this.options[this.selectedIndex].text, this.value);
			});

			//Handle sending chat text
			sendTextBtnEl.addEventListener('click', function() {
				var messageInput = document.getElementById("message-input");
				var chatMessages = document.getElementById("chat-messages");
				chatMessages.innerHTML += '<p style="color:black"> ' + getUserDisplayName() + ": " + messageInput.value + '</p>';
				chatMessages.scrollTop = chatMessages.scrollHeight;				
				NAF.connection.adapter.broadcastData("chat", {txt: messageInput.value, sender: getUserDisplayName(), senderId: NAF.clientId});
				messageInput.value = "";
			});

			//Handle to mute or un-mute
			audioBtnEl.addEventListener('click', function() {
				state.audioEnabled = !state.audioEnabled;		
				var participantName = document.getElementById(NAF.clientId + "_name");
				NAF.connection.adapter.enableMicrophone(state.audioEnabled);				
				
				if (state.audioEnabled) {										
					//audioBtnEl.textContent = 'Un-Mute';
					$('#mic-icon').removeClass("bi-mic-mute");
					$('#mic-icon').addClass("bi-mic");
					var mute_icon = document.getElementById(NAF.clientId + "_mute_icon");
					participantName.removeChild(mute_icon);						
				} else {					
					//audioBtnEl.textContent = 'Mute';
					$('#mic-icon').removeClass("bi-mic");
					$('#mic-icon').addClass("bi-mic-mute");
					/*
					var mute = document.createElement('img');
					mute.setAttribute('id', NAF.clientId + '_mute_icon');
					mute.setAttribute('width', 16);
					mute.setAttribute('height', 16);
					mute.setAttribute('src', 'images/mute.png');
					*/
					var mute = document.createElement('i');
					mute.setAttribute('id', NAF.clientId + '_mute_icon');
					mute.setAttribute('class', 'bi bi-mic-mute');
					mute.setAttribute('style', 'font-size:1.5rem;color:red;')
					participantName.appendChild(mute);
					NAF.connection.adapter.broadcastData("talking", {muteStatus: true, vol: 0, sender: getUserCorpId(), senderId: NAF.clientId});
					setVolLED(0, NAF.clientId);					
				}						
			});

			chatTextBtnEl.addEventListener('click', function() {				
				if ($('#chat-text-icon').hasClass('bi-chat-text')) {
					$('#chat-text-icon').removeClass('bi-chat-text');
					$('#chat-text-icon').addClass('bi-chat-text-fill');
				} else {
					$('#chat-text-icon').removeClass('bi-chat-text-fill');
					$('#chat-text-icon').addClass('bi-chat-text');
				}
				$('#chatUI').toggleClass('show');
			});

			// Handle camera button click (Show and Hide)
			cameraBtnEl.addEventListener('click', async () => {				
				if (state.cameraEnabled) {
					$('#cam-icon').removeClass("bi-camera-fill");
					$('#cam-icon').addClass("bi-camera");
					await stopAndRemoveVideoTrack();
					var camEl = document.querySelector('.share_screen');
					if (camEl != undefined) {
						scene.removeChild(camEl);
					}					
				} else {
					$('#cam-icon').removeClass("bi-camera");
					$('#cam-icon').addClass("bi-camera-fill");
					const stream = await navigator.mediaDevices.getUserMedia(
						{video: {mediaSource: "camera",
							width: {max: 1280, ideal: 640},
							height: {ideal: 360},
							frameRate: 30}});					
					state.currentStream.addTrack(stream.getVideoTracks()[0]);
					await NAF.connection.adapter.setLocalMediaStream(state.currentStream);
					
					var el = document.createElement('a-entity');
					el.setAttribute('class', 'scr');
					el.setAttribute('networked', 'template:#share-screen-template');					
					scene.appendChild(el);
				}			
				screenBtnEl.disabled = !state.cameraEnabled;
				state.cameraEnabled = !state.cameraEnabled;
				//cameraBtnEl.textContent = state.cameraEnabled ? 'Hide Camera' : 'Show Camera';								
				NAF.connection.adapter.broadcastData("streaming", {camStatus: state.cameraEnabled, screenStatus: state.screenEnabled, sender: getUserCorpId(), senderId: NAF.clientId});
			});

			screenBtnEl.addEventListener('click', async () => {
				if (state.screenEnabled) {
					$('#screen-icon').removeClass("bi-tv-fill");
					$('#screen-icon').addClass("bi-tv");
					await stopAndRemoveVideoTrack();
					var screenEl = document.querySelector('.share_screen');
					if (screenEl != undefined) {
						scene.removeChild(screenEl);
					}
				} else {
					$('#screen-icon').removeClass("bi-tv");
					$('#screen-icon').addClass("bi-tv-fill");
					navigator.mediaDevices.getDisplayMedia({video: true}).then((stream) => {						
						state.currentStream.addTrack(stream.getVideoTracks()[0]);
						NAF.connection.adapter.setLocalMediaStream(state.currentStream);
					});

					var el = document.createElement('a-entity');
					el.setAttribute('class', 'scr');
					el.setAttribute('networked', 'template:#share-screen-template');	
					
					scene.appendChild(el);										
				}
				cameraBtnEl.disabled = !state.screenEnabled;
				state.screenEnabled = !state.screenEnabled;
				//screenBtnEl.textContent = state.screenEnabled ? 'Stop Screen Share' : 'Start Screen Share';
				
				NAF.connection.adapter.broadcastData("streaming", {camStatus: state.cameraEnabled, screenStatus: state.screenEnabled, sender: playerInfo.nickname, senderId: NAF.clientId});
			});
			
			helpBtnEl.addEventListener('click', function() {
				if ($('#help-icon').hasClass('bi-question-circle')) {
					$('#help-icon').removeClass('bi-question-circle');
					$('#help-icon').addClass('bi-question-circle-fill');
				} else {
					$('#help-icon').removeClass('bi-question-circle-fill');
					$('#help-icon').addClass('bi-question-circle');
				}
				$('#helpDiv').toggleClass('show');
			});

			scene.addEventListener('adapter-ready', ({ detail: adapter }) => {
				// We don't use the syncOccupants API, set requestedOccupants to be the same array instance as availableOccupants				
				adapter.requestedOccupants = adapter.availableOccupants;
				const clientId = genClientId(); // generate a random 16 characters string, but you can use a uuid4 for example
				adapter.setClientId(clientId);				
				navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
					adapter.setLocalMediaStream(stream).then(() => {
						// Note that networked-scene audio:true option has no effect with the janus adapter
						adapter.enableMicrophone(true); // set it to false if you want to be muted initially.
						state.currentStream = stream;
						adapter.setLocalMediaStream(stream);
						getAudioVol();
					});
				}).catch(err => {
					console.warn("Microphone access not allowed. This client will not broadcast audio.");
				});
			});
			
			var els = document.getElementsByClassName("chair");

			Array.from(els).forEach((el) => {
				// Do stuff here
				//console.log(el.id);
				el.addEventListener('click', function(e) {
					//avatarClicked = networkedComponent.creator;
					//console.log(el.id);
					currentChair = el.id;
					$('.chair-actions').addClass('show');
					$('.chair-actions').css({top: cursorY, left: cursorX});
				});
			});
		});

		// Fired when a networked entity is created 
		document.body.addEventListener("entityCreated", function(evt) {						
			const networkedComponent = evt.detail.el.getAttribute("networked");						
			var networkedComponentChild = evt.detail.el.children;
			usersMap[networkedComponent.creator] = {
				networkId: networkedComponent.networkId,
				el: evt.detail.el
			};			
			if (networkedComponent.creator !== "") {			
				if (networkedComponent.template.indexOf('avatar') >= 0) {	
					//console.log(usersMap);				
					var avatar_div = document.getElementById('naf-' + networkedComponent.networkId);					
					avatar_div.setAttribute('clientId', networkedComponent.creator);
					avatar_div.setAttribute('networkId', networkedComponent.networkId);					
					avatar_div.addEventListener('click', function(e) {	
						avatarClicked = networkedComponent.creator;											
						
						$('.ava-actions').addClass('show') 
						$('.ava-actions').css({top: cursorY, left: cursorX});
						for (let i = 0; i < networkedComponentChild.length; i++) {									
							if (networkedComponentChild[i].className === "nametag") {						
								pmTarget = networkedComponentChild[i].getAttribute('text').value;								
							}
						}						
					});
				}
				var photo_filename = '';
				for (let i = 0; i < networkedComponentChild.length; i++) {										
					if (networkedComponentChild[i].className === "photo") {						
						photo_filename = networkedComponentChild[i].getAttribute("text").value;						
					}
				}

				for (let i = 0; i < networkedComponentChild.length; i++) {
					if (networkedComponentChild[i].className === "nametag") {
						var sel = document.getElementById("select-pm-target");							
						var opt = document.createElement('option');
						opt.value = networkedComponent.creator;
						opt.innerHTML = networkedComponentChild[i].getAttribute('text').value;
						sel.appendChild(opt);

						setParticipant(networkedComponent.creator, networkedComponentChild[i].getAttribute("text").value, photo_filename, true);
					}
				}
				
				//send all chair status to new participant after 1.5s
				//console.log("send all chair status to new participant (myself):" + NAF.clientId);
				//console.log("send all chair status to new participant:" + networkedComponent.creator);
				setTimeout(function() { 
					NAF.connection.adapter.broadcastData("allChairStatus", {chairStatus: chairs, targetId: networkedComponent.creator, sender: getUserCorpId(), senderId: NAF.clientId});
				}, 1500);
			}
		});

		// Fired when another client disconnects from you   
		document.body.addEventListener("clientDisconnected", function(evt) {
			if (usersMap[evt.detail.clientId]) {
				delete usersMap[evt.detail.clientId];
				removeParticipant(evt.detail.clientId);
				releaseChair(evt.detail.clientId);
				var sel = document.getElementById("select-pm-target");
				var opts = sel.options;
				for (let i = 1; i < opts.length; i++) {
					sel.removeChild(opts[i]);
				}
			}		
		});		

		function onConnect() {			
			//addSchema();			
			if(history.replaceState) history.replaceState({}, "", "/");			
			console.log("onConnect", new Date());
			//console.log("Client ID: " + NAF.clientId);		
			var naf_adapter = NAF.connection.adapter;
			//console.log("NAF Adapter: ", naf_adapter);				
			//setParticipant(NAF.clientId, getUserCorpId(), false);
			setParticipant(NAF.clientId, playerInfo.nickname, playerInfo.photo, false);

			//Set player animation
			var player = document.getElementById('player');			
			
			wavingBtnEl.addEventListener('click', function() {
				//player.setAttribute('animation-mixer', 'clip', 'waving');
				//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				//if (sitFlag == "Y") {
				if (state.sit) {
					player.setAttribute('animation-mixer', 'clip', 'sittingcheer');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'sittingidle');	}, 4000);
				} else {				
					player.setAttribute('animation-mixer', 'clip', 'waving');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				}
			});

			/*
			shakeHandBtnEl.addEventListener('click', function() {
				//player.setAttribute('animation-mixer', 'clip', 'shakinghand');
				//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				//if (sitFlag == "Y") {
				if (state.sit) {
					player.setAttribute('animation-mixer', 'clip', 'shakinghand');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'sittingidle');	}, 3000);
				} else {				
					player.setAttribute('animation-mixer', 'clip', 'shakinghand');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				}
			});
			*/
			raiseHandBtnEl.addEventListener('click', function() {
				//player.setAttribute('animation-mixer', 'clip', 'handraising');
				//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				//if (sitFlag == "Y") {
				if (state.sit) {
					player.setAttribute('animation-mixer', 'clip', 'sittingraise');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'sittingidle');	}, 3000);
				} else {		
					player.setAttribute('animation-mixer', 'clip', 'handraising');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				}
			});
			
			clapHandBtnEl.addEventListener('click', function() {
				//player.setAttribute('animation-mixer', 'clip', 'clapping');
				//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				//if (sitFlag == "Y") {
				if (state.sit) {
					player.setAttribute('animation-mixer', 'clip', 'sittingclap');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'sittingidle');	}, 3000);
				} else {		
					player.setAttribute('animation-mixer', 'clip', 'clapping');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				}
			});
			
			yesBtnEl.addEventListener('click', function() {
				//player.setAttribute('animation-mixer', 'clip', 'yes');
				//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				//if (sitFlag == "Y") {
				if (state.sit) {
					player.setAttribute('animation-mixer', 'clip', 'sittingyes');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'sittingidle');	}, 3000);
				} else {		
					player.setAttribute('animation-mixer', 'clip', 'yes');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3500);
				}
			});
			
			noBtnEl.addEventListener('click', function() {
				//player.setAttribute('animation-mixer', 'clip', 'no');
				//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				//if (sitFlag == "Y") {
				if (state.sit) {
					player.setAttribute('animation-mixer', 'clip', 'sittingno');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'sittingidle');	}, 3800);
				} else {		
					player.setAttribute('animation-mixer', 'clip', 'no');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 4000);
				}
			});
			
			gangnamBtnEl.addEventListener('click', function() {
				//player.setAttribute('animation-mixer', 'clip', 'gangnam');
				//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				//if (sitFlag == "Y") {
				if (state.sit) {
					//player.setAttribute('animation-mixer', 'clip', 'gangnam');
					//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'sittingidle');	}, 10000);
				} else {		
					player.setAttribute('animation-mixer', 'clip', 'gangnam');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 12500);
				}
			});
			
			hiphopBtnEl.addEventListener('click', function() {
				//player.setAttribute('animation-mixer', 'clip', 'hiphop');
				//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 3000);
				//if (sitFlag == "Y") {
				if (state.sit) {
					//player.setAttribute('animation-mixer', 'clip', 'hiphop');
					//setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'sittingidle');	}, 10000);
				} else {		
					player.setAttribute('animation-mixer', 'clip', 'hiphop');
					setTimeout(function() { player.setAttribute('animation-mixer', 'clip', 'idle');	}, 17500);
				}
			});

			//PM Message
			pmBtnEl.addEventListener('click', function() {																
				setPM(pmTarget, avatarClicked);				
			});

			teleportBtnEl.addEventListener('click', function(e) {				
				var target = document.getElementById('naf-' + usersMap[avatarClicked].networkId);
				console.log(target);
				console.log(target.getAttribute('position'));
				console.log(target.getAttribute('rotation'));

				var pos = target.getAttribute('position');

				//me.setAttribute('look-at', '#naf-' + usersMap[avatarClicked].networkId);
				var newX = pos.x + 2;
				var newY = pos.y;
				var newZ = pos.z + 2;
				teleportTo(newX+' '+newY+' '+newZ);
				
				var p = document.getElementById('player');
				p.components["look-controls"].pitchObject.rotation.x = 0;
				p.components["look-controls"].yawObject.rotation.y = 0.7875;
				//p.setAttribute('animation-mixer', 'clip', 'idle');
				//var c = document.getElementById('cam');
				//c.setAttribute('position', '0 2.6 0');
				
				//if (sitFlag == "Y") {
				if (state.sit) {
					leaveChair();
				}
			});

			sitdownBtnEl.addEventListener('click', function(e) {
				if (chairs[currentChair]["user"] == "") {
					//clearInterval(sitRefreshIntervalId);
					//if (sitFlag == "Y") {
					if (state.sit) {
						leaveChair();
					}
					
					//sitFlag = "Y";
					state.sit = true;
					chairs[currentChair]["user"] = NAF.clientId;					
					NAF.connection.adapter.broadcastData("chairStatus", {usedFlag: "Y", currentChairId: currentChair, sender: getUserCorpId(), senderId: NAF.clientId});
					
					//console.log('chairs sit: ' + JSON.stringify(chairs));
					
					var chairPosition = document.getElementById(currentChair);
					//console.log("currentChair: ", currentChair);
					var pos = chairPosition.getAttribute('position');
					
					//console.log("pos: ", pos);
					
					var newX = pos.x+0.15;
					var newY = pos.y+0.35;
					var newZ = pos.z;
					teleportTo(newX+' '+newY+' '+newZ);
					
					var p = document.getElementById('player');
					p.setAttribute('animation-mixer', 'clip', 'sittingidle');
					p.components["look-controls"].pitchObject.rotation.x = 0.15;
					p.components["look-controls"].yawObject.rotation.y = chairs[currentChair]["yaxis"];
					//console.log("chairs[currentChair][yaxis]: ", chairs[currentChair]["yaxis"]);
					
					var c = document.getElementById('cam');
					c.setAttribute('position', '0 ' + sitdownEyeLevel + ' 0');
					
					var c = document.getElementById(currentChair);
					sitRefreshIntervalId = setInterval(function () { 
											var playerAvatarRotation = p.getAttribute('rotation');
											//console.log("playerAvatarRotation: ", playerAvatarRotation);
											//c.setAttribute('rotation', 'y', playerAvatarRotation.y-180);
											//secondaryCamera.object3D.rotation.copy('90 90 90');
											//console.log("secondaryCamera: ", secondaryCamera.getAttribute('position'));
											if (chairYAxis != playerAvatarRotation.y-180) {
												c.setAttribute('rotation', 'y', playerAvatarRotation.y-180);
												//console.log("chairRotate broadcastData");
												NAF.connection.adapter.broadcastData("chairRotate", {chairRotationY: playerAvatarRotation.y-180, currentChairId: currentChair, sender: getUserCorpId(), senderId: NAF.clientId});
											}
											chairYAxis = playerAvatarRotation.y-180;
										}, 10);
				}
			});
			/*
			closePmBtnEl.addEventListener('click', function() {						
				var pmMessageInput = document.getElementById("pm-message-input");
				var pmMessages = document.getElementById("pm-messages");
				pmMessageInput.value = "";
				pmMessages.innerHTML = "";
				$('.pm-div').removeClass('show');
			});
			*/

			sendPmTextBtnEl.addEventListener('click', function() {				
				var pmMessageInput = document.getElementById("pm-message-input");
				var pmMessages = document.getElementById("pm-messages");
				pmMessages.innerHTML += '<p style="color:black"> ' + getUserDisplayName() + ": " + pmMessageInput.value + '</p>';
				pmMessages.scrollTop = pmMessages.scrollHeight;				
				NAF.connection.adapter.reliableTransport = "websocket";
				NAF.connection.adapter.sendDataGuaranteed(currentPmClientId, "pm", {msg: pmMessageInput.value, sender: getUserDisplayName(), senderId: NAF.clientId});							
				pmMap[currentPmClientId].msg = pmMessages.innerHTML;				
				pmMessageInput.value = "";
			});	

			document.getElementById("spectatorDiv").style.display = "none";
			mapBtnEl.addEventListener('click', function() {
				if ($('#map-icon').hasClass('bi-map')) {
					$('#map-icon').removeClass('bi-map');
					$('#map-icon').addClass('bi-map-fill');
				} else {
					$('#map-icon').removeClass('bi-map-fill');
					$('#map-icon').addClass('bi-map');
				}
				if (mapOpenedFlag == 'N' ) {
					/*var playerAvatar = document.getElementById('player');
					var secondaryCamera = document.getElementById('secondaryCamera');
					refreshIntervalId = setInterval(function () { 
											var playerAvatarPosition = playerAvatar.getAttribute('position');
											//console.log("playerAvatarPosition: ", playerAvatarPosition);
											secondaryCamera.setAttribute('position', playerAvatarPosition.x + ' ' + secondaryCameraY + ' ' + playerAvatarPosition.z);
											//console.log("secondaryCamera: ", secondaryCamera.getAttribute('position'));
										}, 10);*/
					mapFixedMode();
					document.getElementById("spectatorDiv").style.display = "";
					document.getElementById("spectatorDiv").style.opacity = "1";
					mapOpenedFlag = 'Y';
					mapFixedModeFlag = 'Y';
				} else if (mapOpenedFlag == 'Y' ) {
					clearInterval(refreshIntervalId);
					document.getElementById("spectatorDiv").style.display = "none";
					mapOpenedFlag = 'N';
					mapFixedModeFlag = 'Y';
				}
					
			});

			mapModeBtnEl.addEventListener('click', function() {
				
				if (mapFixedModeFlag == 'Y' ) {					
					mapNonFixedMode();
					mapFixedModeFlag = 'N';
					mapModeBtnEl.textContent = "Switch to Room Centric Mode";
				} else if (mapFixedModeFlag == 'N' ) {
					clearInterval(refreshIntervalId);
					mapFixedMode();
					mapFixedModeFlag = 'Y';
					mapModeBtnEl.textContent = "Switch to Player Centric Mode";
				}
					
			});
			
			presentBtnEl.addEventListener('click', function() {
				if (state.presentEnabled) {
					$('#present-icon').removeClass("bi-file-easel-fill");
					$('#present-icon').addClass("bi-file-easel");					
				} else {
					$('#present-icon').removeClass("bi-file-easel");
					$('#present-icon').addClass("bi-file-easel-fill");	
					//if (sitFlag == "Y") {
					if (state.sit) {
						leaveChair();
					}
					
					var playerAvatar = document.getElementById('player');
					playerAvatar.setAttribute('position', '5.5 0.2 -22');
					//playerAvatar.setAttribute('animation-mixer', 'clip', 'idle');
					playerAvatar.components["look-controls"].pitchObject.rotation.x = 0;
					playerAvatar.components["look-controls"].yawObject.rotation.y = 2.2;
					//var c = document.getElementById('cam');
					//c.setAttribute('position', '0 2.6 0');
					
					var chairSeq = ['computerchair5', 'computerchair4', 'computerchair6', 'computerchair3', 'computerchair7', 'computerchair2', 'computerchair8', 'computerchair1', 'computerchair9'];
					var chairAva = [];
					var userAva = [];
					var userChairMap = {};
					var index = 0;
					var foundFlag = 'N';
					var counter = 0;
					
					for (let i = 0; i < chairSeq.length; i++) {
						//console.log("chairSeq: ", chairSeq[i]);
						if (chairs[chairSeq[i]]["user"] == "") {
							chairAva[index++] = chairSeq[i];
						}
					}
					
					index = 0;
					$.each( usersMap, function( key, value ) {
						if (key != "" && key != NAF.clientId) {
							foundFlag = 'N';
							$.each( chairs, function( keyb, value ) {
								if (keyb != "" && chairs[keyb]["user"] == key) {
									foundFlag = 'Y';
								}
							});
							
							if (foundFlag == 'N') {
								userAva[index++] = key;
							}
						}
					});
									
					if (chairAva.length > userAva.length) {
						counter = userAva.length;
					} else {
						counter = chairAva.length;
					}
					
					for (let i = 0; i < counter; i++) {
						userChairMap[userAva[i]] = chairAva[i];
					}
					
					NAF.connection.adapter.broadcastData("present", {userChairMap: userChairMap, sender: getUserCorpId(), senderId: NAF.clientId});
				}
				
				state.presentEnabled = !state.presentEnabled;
				NAF.connection.adapter.broadcastData("presentButtonStatus", {presentStatus: state.presentEnabled, sender: playerInfo.nickname, senderId: NAF.clientId});
				//console.log("counter: ", counter);
				//console.log("chairAva: ", JSON.stringify(chairAva));
				//console.log("userAva: ", JSON.stringify(userAva));
				//console.log("userChairMap: ", JSON.stringify(userChairMap));				
			});
			
			document.getElementById("spectatorScreenDiv").style.display = "none";
			viewScreenBtnEl.addEventListener('click', function() {
				if ($('#viewscreen-icon').hasClass('bi-aspect-ratio')) {
					$('#viewscreen-icon').removeClass('bi-aspect-ratio');
					$('#viewscreen-icon').addClass('bi-aspect-ratio-fill');
				} else {
					$('#viewscreen-icon').removeClass('bi-aspect-ratio-fill');
					$('#viewscreen-icon').addClass('bi-aspect-ratio');
				}
				
				if (viewScreenOpenedFlag == 'N' ) {					
					document.getElementById("spectatorScreenDiv").style.display = "";
					document.getElementById("spectatorScreenDiv").style.opacity = "1";
					viewScreenOpenedFlag = 'Y';
				} else if (viewScreenOpenedFlag == 'Y' ) {
					document.getElementById("spectatorScreenDiv").style.display = "none";
					viewScreenOpenedFlag = 'N';
				}
			});

			document.addEventListener('keydown', function(evt) {
				if (evt.keyCode === 87 || evt.keyCode === 65 || evt.keyCode === 83 || evt.keyCode === 68 || evt.keyCode ===38 || evt.keyCode === 37 || evt.keyCode === 39 || evt.keyCode === 40) {
					//if (sitFlag == "Y") {
					if (state.sit) {
						leaveChair();
					}
					
					player.setAttribute('animation-mixer', 'clip', 'walking');
					//var c = document.getElementById('cam');
					//c.setAttribute('position', '0 2.6 0');
					//clearInterval(sitRefreshIntervalId);					
				}
			});
			
			document.addEventListener('keyup', function(evt) {
				if (evt.keyCode === 87 || evt.keyCode === 65 || evt.keyCode === 83 || evt.keyCode === 68 || evt.keyCode ===38 || evt.keyCode === 37 || evt.keyCode === 39 || evt.keyCode === 40) {
					//if (sitFlag == "Y") {
					if (state.sit) {
						leaveChair();
					}
					
					player.setAttribute('animation-mixer', 'clip', 'idle');
					//var c = document.getElementById('cam');
					//c.setAttribute('position', '0 2.6 0');
					//clearInterval(sitRefreshIntervalId);					
				}
				if (evt.keyCode === 49) {					
					wavingBtnEl.click();					
				}

				if (evt.keyCode === 50) {					
					raiseHandBtnEl.click();
				}	

				if (evt.keyCode === 51) {				
					clapHandBtnEl.click();
				}	
				
				if (evt.keyCode === 52) {					
					gangnamBtnEl.click();
				}	
				
				if (evt.keyCode === 53) {					
					hiphopBtnEl.click();
				}	

				if (evt.keyCode === 89) {					
					yesBtnEl.click();
				}	
				
				if (evt.keyCode === 78) {					
					noBtnEl.click();
				}	
			});
			//End set player animation

			NAF.connection.subscribeToDataChannel("talking", (senderId, dataType, data, targetId) =>{								
				if (usersMap[data.senderId]) {
					var senderEl = document.getElementById(data.senderId + "_name");
					var mute_icon = document.getElementById(data.senderId + "_mute_icon");
					setVolLED(data.vol, data.senderId);
					if (data.muteStatus) {
						if (mute_icon == undefined) {
							var mute = document.createElement('i');
							mute.setAttribute('id', data.senderId + '_mute_icon');							
							//mute.setAttribute('width', 16);
							//mute.setAttribute('height', 16);
							//mute.setAttribute('src', 'images/mute.png');					
							mute.setAttribute('class', 'bi bi-mic-mute');
							mute.setAttribute('style', 'font-size:1.5rem; color:red;')
							senderEl.appendChild(mute);
						}
					} else {
						if (mute_icon != undefined) {
							senderEl.removeChild(mute_icon);						
						}
					}										
				}				
			});

			NAF.connection.subscribeToDataChannel("streaming", (senderId, dataType, data, targetId) => {
				//data.camStatus = true --> disable the camera-btn
				//data.screenStatus = true --> disable the screen-btn		
				console.log("camStatus: ", data.camStatus);
				console.log("screenStatus: ", data.screenStatus);				
				console.log(data);
				if (data.camStatus || data.screenStatus) {
					cameraBtnEl.disabled = true;			
					screenBtnEl.disabled = true;
				} else {
					cameraBtnEl.disabled = false;			
					screenBtnEl.disabled = false;
				}			
				//var scr_usr = document.getElementById('scr_user');
				//scr_usr.setAttribute('text', 'value: ' + data);	
			});

			NAF.connection.subscribeToDataChannel("chat", (senderId, dataType, data, targetId) => {
				var messageInput = document.getElementById("message-input");
				var chatMessages = document.getElementById("chat-messages");
				chatMessages.innerHTML += '<p style="color:blue"> ' + data.sender + ": " + data.txt + '</p>';
				chatMessages.scrollTop = chatMessages.scrollHeight;				
			});

			NAF.connection.subscribeToDataChannel("pm", (senderId, dataType, data, targetId) => {				
				console.log("data: ", data);	
				console.log(pmMap);
				if (!pmMap[data.senderId]) {
					countPmContent++;
					pmMap[data.senderId] = {
						name: data.sender,
						msg: ''
					};					
				} 				
							
				if (currentPmTarget === data.sender) {
					currentPmTarget = data.sender;
					currentPmClientId = data.senderId;
											
					var pmMessageInput = document.getElementById("pm-message-input");
					var pmMessages = document.getElementById("pm-messages");
					pmMessages.innerHTML = pmMap[data.senderId].msg;
					pmMessages.innerHTML += '<p style="color:blue"> ' + data.sender + ": " + data.msg + '</p>';
					pmMessages.scrollTop = pmMessages.scrollHeight;						
					
					pmMap[data.senderId].msg = pmMessages.innerHTML;
				} else if (currentPmTarget === '' || currentPmTarget !== data.sender) {					
					var target_div = document.getElementById(data.senderId + "_name");
					/*
					var new_msg = document.createElement('img');
					new_msg.setAttribute('id', data.senderId + '_msg');
					new_msg.setAttribute('src', 'images/new_msg.png');
					new_msg.setAttribute('width', 32);
					new_msg.setAttribute('height', 32);
					*/
					var new_msg = document.createElement('i');
					new_msg.setAttribute('id', data.senderId + '_msg');
					new_msg.setAttribute('class', 'bi bi-envelope-plus');
					new_msg.setAttribute('style', 'font-size:2rem; color: yellow;')
					target_div.appendChild(new_msg);
					pmMap[data.senderId].msg += '<p style="color:blue"> ' + data.sender + ": " + data.msg + '</p>';
					new_msg.addEventListener('click', function() {
						avatarClicked = data.senderId;
						pmTarget = data.sender;
						setPM(pmTarget, avatarClicked);
						target_div.removeChild(new_msg);
						switchChat('pm-div')	
					});					
				}
							
			});

			NAF.connection.subscribeToDataChannel("chairRotate", (senderId, dataType, data, targetId) => {
				var currentChair = document.getElementById(data.currentChairId);
				
				currentChair.setAttribute('rotation', 'y', data.chairRotationY);	
			});
			
			NAF.connection.subscribeToDataChannel("chairStatus", (senderId, dataType, data, targetId) => {
				if (data.usedFlag == "Y") {
					chairs[data.currentChairId]["user"] = data.senderId;
					//console.log('chairs subscribe Y ');
				}
				
				if (data.usedFlag == "N") {
					/*$.each( chairs, function( key, value ) {
						if (key != "") {
							if (chairs[key]["user"] == data.senderId) {
								chairs[key]["user"] = "";
							}
						}
					});*/
					
					releaseChair(data.senderId);					
					//console.log('chairs subscribe N ');
				}				
				//console.log('chairs subscribe: ' + JSON.stringify(chairs));
			});
			
			NAF.connection.subscribeToDataChannel("present", (senderId, dataType, data, targetId) => {	
				if (data.userChairMap[NAF.clientId] != "" && data.userChairMap[NAF.clientId] != "undefined" && data.userChairMap[NAF.clientId] != null) {
					//console.log('present subscribe: ' + data.userChairMap[NAF.clientId]);
					currentChair = data.userChairMap[NAF.clientId];
					sitdownBtnEl.click();
				} else {
					$.each( chairs, function( key, value ) {
						if (key != "") {
							if (chairs[key]["user"] == NAF.clientId) {	//already sit down							
								var p = document.getElementById('player');
								p.components["look-controls"].pitchObject.rotation.x = 0.15;
								p.components["look-controls"].yawObject.rotation.y = chairs[key]["yaxis"];								
							}
						}
					});
				}
			});
			
			NAF.connection.subscribeToDataChannel("presentButtonStatus", (senderId, dataType, data, targetId) => {				
				if (data.presentStatus) {
					presentBtnEl.disabled = true;
				} else {
					presentBtnEl.disabled = false;
				}	
			});
			
			NAF.connection.subscribeToDataChannel("allChairStatus", (senderId, dataType, data, targetId) => {
				//console.log('allChairStatus subscribe1 data.senderId: ' + data.senderId);
				//console.log('allChairStatus subscribe1 data.targetId: ' + data.targetId);
				//console.log('allChairStatus subscribe2 data.chairStatus: ' + JSON.stringify(data.chairStatus));
				if (data.targetId == NAF.clientId) {
					//chairs = data.chairStatus;					
					//console.log('allChairStatus subscribe: ' + JSON.stringify(data.chairStatus));
					$.each( data.chairStatus, function( key, value ) {
						if (key != "") {
							if (data.chairStatus[key]["user"] != "") {
								chairs[key]["user"] = data.chairStatus[key]["user"];					
							}
						}
					});
					//console.log('allChairStatus subscribe chairs local!!: ' + JSON.stringify(chairs));
				}
			});
		}				

		$(window).on('click', e => {			
			const target = e.target
			//console.log('click');
			//console.log(target);
			if (target.matches('.a-mouse-cursor-hover')) {
				//When click on the avatar, there would be 3 events
				//First event is from a-scene
				//Then from the avatar which the class=head
				//Last from canvas with class a-canvas, a-grab-cursor and a-mouse-cursor-hover
				//Seems the a-mouse-cursor-hover only exists when click the avatar
				//To remove the 'show' class on the avatar actions, ignore the a-mouse-cursor-hover event
				return;
			}  							
			
			if (!target.matches('.head') && !target.matches('.participant_photo')) {
				if ($('.ava-actions').hasClass('show')) {
					$('.ava-actions').removeClass('show')
				}				
			}
			/*
			if (target.matches('.greetings-btn')) { 
    			return $('.g-btn').toggleClass('show');
			}			 
			*/
  			if (!target.matches('[data-inside]')) { 
    			$('.g-btn').removeClass('show');
			}

			if (!target.matches('.chair')) {
				$('.chair-actions').removeClass('show');
			}
		});

		$(window).on('mousedown', e => {			
			if (e.pageX != 'undefined' || e.clientX != 'undefined') {
				if (e.pageX == null && e.clientX != null) {
					cursorX = e.clientX;
					cursorY = e.clientY;
				} else if (e.pageX != null) {
					cursorX = e.pageX;
					cursorY = e.pageY;
				}
			}			  
		});
		
		
	</script>
  </body>
</html>
